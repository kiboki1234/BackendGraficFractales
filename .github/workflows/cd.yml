name: CD - Backend (Render)

on:
  workflow_run:
    workflows: ["CI - Backend"]   # Debe llamarse exactamente como tu workflow de CI
    types: [completed]

permissions:
  contents: read

jobs:
  deploy:
    name: Trigger Render Deploy
    runs-on: ubuntu-latest
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    steps:
      - name: Trigger Render Deploy Hook
        run: |
          curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

      # (Opcional) Espera a que el servicio esté saludable antes de continuar (sondea /health)
      - name: Wait for healthy backend
        env:
          BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
        run: |
          echo "Esperando a que $BASE_URL/health responda 200..."
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health" || true)
            if [ "$code" = "200" ]; then
              echo "OK!"
              exit 0
            fi
            echo "Intento $i: status=$code; reintentando en 10s..."
            sleep 10
          done
          echo "El backend no respondió 200 a tiempo."
          exit 1
