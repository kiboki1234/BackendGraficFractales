name: CD - Backend (Render)

on:
  workflow_run:
    workflows: ["CI - Backend"]
    types: [completed]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: >
      ${{
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'main'
      }}
    steps:
      - name: Trigger Render Deploy Hook
        run: curl -fsS -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"

      - name: Wait for healthy backend
        env:
          BASE_URL: ${{ secrets.BACKEND_BASE_URL }}
        run: |
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health" || true)
            if [ "$code" = "200" ]; then exit 0; fi
            echo "Intento $i status=$code; sleep 10s"; sleep 10
          done
          exit 1
