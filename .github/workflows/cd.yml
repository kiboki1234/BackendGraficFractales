name: CD - Backend (Render)

on:
  workflow_run:
    # Debe coincidir EXACTO con el name: de tu CI
    workflows: ['CI + k6']
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy a Render si CI+k6 OK
    runs-on: ubuntu-latest
    # Solo si el CI terminó OK y viene de main
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.head_branch == 'main'

    # --- aquí mapeas el secret a una env var ---
    env:
      BACKEND_URL: ${{ secrets.BACKEND_BASE_URL }}
      RENDER_DEPLOY_HOOK: ${{ secrets.RENDER_DEPLOY_HOOK }}

    # Esto muestra el badge/URL en la UI de GitHub
    environment:
      name: production
      url: ${{ env.BACKEND_URL }}

    steps:
      - name: Trigger Render deploy hook
        run: curl -fsS -X POST "$RENDER_DEPLOY_HOOK"

      - name: Esperar a que el backend esté healthy
        run: |
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || true)
            if [ "$code" = "200" ]; then
              echo "Healthy ✅"; exit 0
            fi
            echo "Intento $i => $code, esperando 10s…"; sleep 10
          done
          echo "No levantó ❌"; exit 1
